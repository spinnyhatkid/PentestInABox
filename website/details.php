<?php
  if (filter_var($_GET['ip'], FILTER_VALIDATE_IP)) {
    $ip = $_GET['ip'];
  } else {
    die("Error: invalid IP address!");
  }
  if (filter_var($_GET['port'], FILTER_VALIDATE_INT)) {
    $current_port = $_GET['port'];
  } else {
     die("Error: invalid port!");
  }
  if (!empty($_GET['scan'])) {
    $scan = $_GET['scan'];
  }
  if (filter_var($_GET['error'], FILTER_VALIDATE_INT)) {
    $err = $_GET['error'];
  }
?>
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">
    <link rel="icon" href="../../favicon.ico">

    <title>Pentest in a Box</title>

    <!-- Bootstrap core CSS -->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap.min.css">
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap-theme.min.css">

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
    <!-- Custom styles for this template -->
    <link href="dashboard.css" rel="stylesheet">

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
  </head>

  <body>
  <script>
        $(function() {

            $(".knob").knob({
                /*change : function (value) {
                    //console.log("change : " + value);
                },
                release : function (value) {
                    console.log("release : " + value);
                },
                cancel : function () {
                    console.log("cancel : " + this.value);
                },*/
                                });
        });
    </script>

    <?php
      $scan_check = array('New', 'Requested', 'Running');
      $run_wait = false;
      $ports_array = array();
      $ports_file = fopen("ssshp","r");
      $tmp_file = fopen("ssshp.tmp","r+");
      if (isset($current_port)) {
        $tmp_contents = file_get_contents("ssshp.tmp");
        preg_match("/.*" . $current_port . ".*/i", $tmp_contents, $match);
      }

      while (!feof($ports_file)) {
        $port = fgets($ports_file);
        $type = explode(",", $port);

        if (isset($current_port) && stristr($port, $current_port)) {
          if (isset($match) && !empty($match)) {
            $match_content = explode(":",$match[0]);
            if ($type[3] == '' || $type[3] == "\n") {
              $run_wait = true;
            }
          }

          if (isset($scan)) {
            if ($port != '' && $type[3] != '' && $type[3] != "\n" && $scan != "status") {
              fclose($ports_file);
              fclose($tmp_file);
              header("Location: details.php?ip=" . $ip . "&port=" . $current_port . "&error=2");
            }

            if (flock($tmp_file, LOCK_EX)) {
              if ($scan != "status") {
                fputs($tmp_file, $current_port . ":" . $scan);
              }
              flock($tmp_file, LOCK_UN);

              $return_port = $current_port + 1000;
              $connection = ssh2_connect('localhost', $return_port, array('hostkey'=>'ssh-rsa'));
              if (ssh2_auth_pubkey_file($connection, 'root', '/var/www/.ssh/id_rsa.pub', '/var/www/.ssh/id_rsa')) {
                if ($scan == "Requested") {
                  ssh2_exec($connection, '/etc/penScanCall.py -t o -i ' . $ip . ' > /dev/null 2>/dev/null &');
                }
                if ($scan == "OvStop") {
                  ssh2_exec($connection, '/etc/penScanCall.py -t op ' . ' > /dev/null 2>/dev/null &');
                }
                if ($scan == "OvResume") {
                  ssh2_exec($connection, '/etc/penScanCall.py -t or ' . ' > /dev/null 2>/dev/null &');
                }
                if ($scan == "OvCleanUp") {
                  ssh2_exec($connection, '/etc/penScanCall.py -t os ' . ' > /dev/null 2>/dev/null &');
                }
                if ($scan == "status") {
                  $stream = ssh2_exec($connection, '/etc/penScanCall.py -t s');
                  stream_set_blocking($stream, true);
                  $status_update = stream_get_contents($stream);
                }

                ssh2_exec($connection, 'exit');
                unset($connection);
              }

              $port .= $scan;
            }
          }
        }


        if ($port != '') {
          array_push($ports_array, $port);
        }
      }
      fclose($ports_file); fclose($tmp_file);
    ?>

    <nav class="navbar navbar-inverse navbar-fixed-top" role="navigation">
      <div class="container-fluid">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="#">Hack in a Box</a>
        </div>
      </div>
    </nav>

    <?php
      if (isset($err)) {
        if ($err == 1) {
          echo "<div class='alert alert-danger' role='alert'>Error: The selected Raspberry PI seems to be offline, please wait a couple minutes and refresh the browser to get an update list of connected Raspberry PIs.</div>";
        }
        if ($err == 2) {
          echo "<div class='alert alert-danger' role='alert'>Error: A scan is already running, wait for it to complete and try again.</div>";
        }
      }
    ?>

    <div class="container-fluid">
      <div class="row">
        <div class="col-sm-9 col-sm-offset-1 col-md-10 col-md-offset-1 main">
          <h1 class="page-header">Details for <?php echo $ip ?></h1>
          <?php
            $current_info = array();
            foreach ($ports_array as $port) {
              $port_info = explode(",", $port);

              if (isset($current_port) && $current_port == $port_info[0]) {
                $current_info = $port_info;
              }
            }

            $scan_status = array();
            echo "<span class=\"text-muted\">Scan status: ";
            if (isset($status_update)) {
              echo $status_update . "</span>";
              $scan_status = explode(" ", trim($status_update));
            }
            elseif ($run_wait) {
              echo $match_content[1] . "</span>";
              $scan_status = explode(" ", trim($match_content[1]));
            }
            elseif (!empty($current_info)) {
              echo $current_info[3] . "</span>";
              $scan_status = explode(" ", trim($current_info[3]));
            } else {
              echo "None</span>";
            }
          ?>

          <a name="services"></a>
          <h2 class="sub-header">Services</h2>
          <div class="table-responsive">
            <table class="table table-striped">
              <thead>
                <tr>
                  <th>Port</th>
                  <th>Proto</th>
                  <th>State</th>
                  <th>Name</th>
                  <th>Info</th>
                </tr>
              </thead>
              <tbody>
<?php
  try {
    $db = new PDO('pgsql:dbname=msf3;host=localhost;port=' . $current_port . ';user=msf3;password=msf3');
    if(isset($ip)){
      $stmt = $db->prepare( "SELECT * FROM services WHERE host_id = (SELECT id FROM hosts WHERE address = :ipaddress)" );
      $stmt->execute(array(':ipaddress' => $ip));
    }
    while ($row = $stmt->fetch(PDO::FETCH_ASSOC)) {
      echo "<tr>";
      echo "  <td>" . $row['port'] . "</td>";
      echo "  <td>" . $row['proto'] . "</td>";
      echo "  <td>" . $row['state'] . "</td>";
      echo "  <td>" . $row['name'] . "</td>";
      echo "  <td>" . $row['info'] . "</td>";
      echo "</tr>";
    } 
  } catch (Exception $e) {
    header("Location: index.php?error=1"); /* Redirect browser */
    exit();
  }
?>

              </tbody>
            </table>
          </div>

          <a name="vulns"></a>
          <?php
            echo "<h2 class='sub-header'>Vulnerabilities</h2>";
            echo "<div class='row'>";
              if (!$run_wait && isset($current_port) && ($current_info[3] == '' || $current_info[3] == "\n")) {
                echo "<div class=\"col-xs-5 col-sm-2\">";
                  echo "<form action='details.php'>";
                  echo "  <input type='hidden' name='port' value='" . $current_port . "' />";
                  echo "  <input type='hidden' name='ip' value='" . $ip . "' />";
                  echo "  <button name='scan' value='Requested' type='submit'>Scan Vulnerabilities</button>";
                  echo "</form>";
                echo "</div>";
                echo "<div class=\"col-xs-19 col-sm-10\"></div>";
              }
              if (isset($current_port) && ($current_info[3] != '' && $current_info[3] != "\n")) {
                /*echo "<div class=\"col-xs-5 col-sm-2\">";
                  echo "<form action='details.php'>";
                  echo "  <input type='hidden' name='port' value='" . $current_port . "' />";
                  echo "  <input type='hidden' name='ip' value='" . $ip . "' />";
                  echo "  <button name='scan' value='OvPause' type='submit'>Pause Scan</button>";
                  echo "</form>";
                echo "</div>";
                echo "<div class=\"col-xs-5 col-sm-2\">";
                  echo "<form action='details.php'>";
                  echo "  <input type='hidden' name='port' value='" . $current_port . "' />";
                  echo "  <input type='hidden' name='ip' value='" . $ip . "' />";
                  echo "  <button name='scan' value='OvResume' type='submit'>Resume Scan</button>";
                  echo "</form>";
                echo "</div>";
                echo "<div class=\"col-xs-5 col-sm-2\">";
                  echo "<form action='details.php'>";
                  echo "  <input type='hidden' name='port' value='" . $current_port . "' />";
                  echo "  <input type='hidden' name='ip' value='" . $ip . "' />";
                  echo "  <button name='scan' value='OvCleanUp' type='submit'>Delete Scan</button>";
                  echo "</form>";
                echo "</div>";*/
                if (in_array($scan_status[0], $scan_check)) {
                  echo "<div class=\"col-xs-5 col-sm-2\">";
                    echo "<form action='details.php'>";
                    echo "  <input type='hidden' name='port' value='" . $current_port . "' />";
                    echo "  <input type='hidden' name='ip' value='" . $ip . "' />";
                    echo "  <button name='scan' value='status' type='submit'>Update Status</button>";
                    echo "</form>";
                  echo "</div>";
                  echo "<div class=\"col-xs-19 col-sm-10\"></div>";
                }
              }
          ?>
          <div class="table-responsive">
            <table class="table table-striped">
              <thead>
                <tr>
                  <th>Name</th>
                  <th>Info</th>
                </tr>
              </thead>
              <tbody>
<?php
if(isset($ip)){
  $stmt2 = $db->prepare("SELECT * FROM vulns WHERE host_id = (SELECT id FROM hosts WHERE address = :ipaddress)");
  $stmt2->execute(array(':ipaddress' => $ip));
}
while ($row = $stmt2->fetch(PDO::FETCH_ASSOC)) {
  echo "<tr>";
  echo "  <td>" . $row['name'] . "</td>";
  echo "  <td>" . $row['info'] . "</td>";
  echo "</tr>";
}
?>

              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/js/bootstrap.min.js"></script>
    <script src="jquery.knob.min.js"></script>
  </body>
</html>

